services:
  - type: web
    name: backdoor-gmail-tool
    env: python
    buildCommand: |
      # Make sure pip is up to date
      pip install --upgrade pip
      
      # Explicitly install gunicorn first
      pip install gunicorn==21.2.0
      
      # Install Python requirements
      pip install -r requirements.txt
      
      # Install Playwright in user space without requiring root
      export PLAYWRIGHT_BROWSERS_PATH=$HOME/.cache/ms-playwright
      
      # Install specific version of Playwright that's known to work well
      pip install playwright==1.38.0
      
      # Install Node.js to help with browser installation (NVM doesn't require root)
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install 16
      
      # Use Playwright's browser downloader directly
      mkdir -p $HOME/.cache/ms-playwright
      
      # Install the browser in user space without requiring dependencies
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0 python -m playwright install chromium
      
      # Try npm-based installation as a backup approach
      # This downloads just the browser binary, not the dependencies
      npm install -g playwright-core
      npx playwright install chromium
      
      # Verify gunicorn is installed and in PATH
      echo "Checking gunicorn installation..."
      which gunicorn || echo "gunicorn not found in PATH"
      pip list | grep gunicorn
    startCommand: gunicorn --bind 0.0.0.0:$PORT "app:create_app()" --workers 2 --timeout 120
    envVars:
      - key: PYTHON_VERSION
        value: 3.9.0
      - key: SECRET_KEY
        generateValue: true
      - key: PROXY_LIST
        sync: false
      - key: DEFAULT_PROXY_TYPE
        value: http
    plan: free
    autoDeploy: false
    healthCheckPath: /
    # domains: [] # Optionally, leave empty or omit entirely